{% extends "base_generic_doctor.html" %}
{% block content %}
            <div id="center" data-simplebar>
                <div id="header">
                    <div class="mobile-header-block">
                        <div class="logo">
                            <a href='https://hadassah.moscow/' class="logo">
                                {% load static %}
                                <img src="{% static 'doctor/css/img/logo.svg' %}" alt="">
                            </a>
                        </div>
                        <a class="menu-link" data-sidebar-toggle>
                            <div class="i i-menu"></div>
                        </a>
                        <div class="petrushka">
                            <img src="{% static 'nutritionist/css/img/petrushka.png' %}" alt="">
                        </div>
                    </div>

                    <div class="header-block">
                        <div class="menu-link-and-name">
                            <a class="menu-link" data-sidebar-toggle>
                                <div class="i i-menu"></div>
                            </a>
                            <div class="title">Ваши пациенты</div>
                        </div>

                        <a onclick="changeSymbol('id_full_name')" class="button" data-modal-link="patient-add">
                            <span class="i i-plus"></span>
                            Добавить
                        </a>
                    </div>
                </div>

                <div>
                    {# какая форма сработала  #}
                    <input style="display: none;" type="checkbox" id="add_patient_flag"  name="add_patient">
                    <input style="display: none;" type="checkbox" id="edit_patient_flag"  name="edit_patient_flag">
                    <input style="display: none;" type="checkbox" id="archive"  name="archive">
                    <input style="display: none;" type="text" id="id_edit_user" name="id_edit_user">

                    <input style="display: none;" type="checkbox" id="filter_by_flag"  name="filter_by_flag">
                    <input style="display: none;" type="text" id="filter_by_value"  name="filter_by_value">
                    <input style="display: none;" type="text" id="sorting_value"  name="sorting_value">
                    <input style="display: none;" type="text" id="is_pressing_again"  name="is_pressing_again">

                </div>

                <div style="display: none;" id="filter_by">{{ filter_by }}</div>
                <div style="display: none;" id="sorting">{{ sorting }}</div>
                <div style="display: none;" id="status">{{ modal }}</div>
 
                <a style="display: none;"  id="archived" data-modal-link="patient-archived">a</a>
                <a style="display: none;" id="edited" data-modal-link="patient-edited">Редактировать</a>
                <a style="display: none;" id="patient-added" data-modal-link="patient-added">a</a>
                <a style="display: none;" id="modal-close" data-modal-close>a</a>
                <a style="display: none;" id="password-edited" data-modal-link="password-edited">a</a>
                <a style="display: none;" id="profile-edited" data-modal-link="profile-edited">a</a>
                
 
                <div id="123" class='test' data-modal="patient-archived" data-modal-width="400">
                    <div class="message-block">
                        <div class="icon">
                            <div class="i i-ok"></div>
                        </div>
                        <div class="title">Учётная запись архивирована</div>
                    </div>
                </div>

                <div id="content" data-simplebar>
                    <div class="table"
                        data-columns="30% 20% 30% 1fr"
                        data-columns-mobile="30% 15% 30% 1fr">
                        <div class="tr thead">
                            <div class="th">
                                    <label id="full_name" onclick="check_function('input_full_name')" class="sort" for="input_full_name">
                                        <span style="cursor: pointer;">фио пациента</span></label>
                                    <input type="radio" class="btn-check" id="input_full_name" value="full_name" name="filter_by">
                            </div>
                            <div class="th">
                                    <label id="room_number" onclick="check_function('input_room_number')" class="sort" for="input_room_number">
                                        <span style="cursor: pointer;" class="only-desktop">палата</span>
                                        <span style="cursor: pointer;" class="only-mobile">№</span>
                                    <input type="radio" class="btn-check" id="input_room_number" value="room_number" name="filter_by">
                            </div>
                            <div class="th">
                                    <label id="department" onclick="check_function('input_department')" class="sort" for="input_department">
                                        <span style="cursor: pointer;">отделение</span></label>
                                    <input type="radio" class="btn-check" id="input_department" value="department" name="filter_by">
                            </div>
                            <div class="th">
                                    <label id="type_of_diet" onclick="check_function('input_type_of_diet')" class="sort" for="input_type_of_diet">
                                        <span style="cursor: pointer;">диета</span></label>
                                    <input type="radio" class="btn-check" id="input_type_of_diet" value="type_of_diet" name="filter_by">
                            </div>
                        </div>
                        {% load formatting_full_name %}
                        {% for form in formset %}
                        <div style="display: none;">
                            <input type="text" class="floor-list" value="{{ form.floor.value }}">
                            <input type="text" class="room-list" value="{{ form.room_number.value }}">
                            <input type="text" class="id-list" value="{{ form.id.value }}">
                        </div>
                        <div id="{{ form.id.value }}"
                            class="tr product" data-patient-card-show 
                            onclick="displayInfoPatient('{{ form.full_name.value }}',
                             '{{ form.birthdate.value|date:"d.m.Y" }}',
                              '{{ form.receipt_date.value|date:"d.m.Y" }}',
                               '{{ form.receipt_time.value|time:"H:i" }}',
                                '{{ form.department.value }}',
                                 '{{ form.type_of_diet.value }}',
                                  '{{ form.room_number.value }}',
                                   '{{ form.bed.value }}',
                                    '{{ form.comment.value|cut:"None"  }}',
                                     '{{ form.id.value }}', '{{ form.floor.value }}')">
                            <div class="td">
                                <div class="name ellipsis">{{ form.full_name.value|formatting_full_name }}</div>
                            </div>
                            <div class="td">{{ form.room_number.value }}</div>
                            <div class="td">
                                <div class="ellipsis">
                                    {{ form.department.value }}
                                </div>
                            </div>
                            <div class="td">
                                <span class="tag">{{ form.type_of_diet.value }}</span>
                            </div>
                        </div>

                        <div data-modal="modal-start{{ form.id.value }}" data-modal-width="480">
                                <div class="title">Редактировать профиль пациента</div>
                                    <div id ='full_name_edit' class="form-group">
                                        <label>ФИО пациента</label>
                                        <input id="full_name_{{ form.id.value }}" type="text" value="{{ form.full_name.value }}">
                                        <div id ='error_full_name' class="error-field"></div>
                                    </div>
                                    <div id='birthdate_edit' class="form-group">
                                        {% load widget_tweaks %}
                                        <label>Дата рождения</label>
                                        <input type="text" value="{{ form.birthdate.value|date:'d.m.Y' }}" data-datepicker id="{{ form.birthdate.id_for_label }}">
                                        <div id ='error_birthdate' class="error-field"></div>
                                    </div>
                                    <div id='receipt_date_edit' class="form-group">
                                        {% load widget_tweaks %}
                                        <label>Дата госпитализации</label>
                                        <input type="text" value="{{ form.receipt_date.value|date:'d.m.Y' }}" data-datepicker id="{{ form.receipt_date.id_for_label }}">
                                        <div id ='error_receipt_date' class="error-field"></div>
                                    </div>
                                    <div id='receipt_time_edit' class="form-group">
                                        <label>Время госпитализации</label>
                                        <input type="text" value="{{ form.receipt_time.value|date:'H:i' }}" data-timemask id="{{ form.receipt_time.id_for_label }}">
                                        <div id ='error_receipt_time' class="error-field"></div>
                                    </div>
                                    <div id='type_of_diet_edit' class="form-group">
                                        <label>Диета</label>
                                        {{ form.type_of_diet }}
                                        <div id ='error_type_of_diet' class="error-field"></div>
                                    </div>
                                    <div id='department_edit' class="form-group">
                                        <label>Отделение</label>
                                         {{ form.department }}
                                        <div id ='error_department' class="error-field"></div>
                                    </div>
                                    <div id='floor_edit' class="form-group">
                                        <label>Этаж</label>
                                        <select 
                                        onchange="addRoomNumberEditForm(this.value,
                                         'id-room-number-{{ form.id.value }}',
                                          '{{ form.floor.value }}',
                                          '{{ form.room_number.value }}',
                                          '{{ form.bed.value }}' )" name="floor" id="id-floor-{{ form.id.value }}">
                                            <option class="optionValue" value="Не выбрано">Не выбрано</option>
                                            <option class="optionValue" value="2">2 этаж</option>
                                            <option class="optionValue" value="3">3 этаж</option>
                                            <option class="optionValue" value="4">4 этаж</option>
                                         </select>
                                        <div id ='error_floor' class="error-field"></div>
                                    </div>
                                    
                                    <div id='room_number_edit' class="form-group">
                                        <label>Номер палаты</label>
                                        <select  onchange="addBedEditForm(this.value, 'id_bed-{{ form.id.value }}', '{{ form.room_number.value }}', '{{ form.bed.value }}')" name="room_number" id='id-room-number-{{ form.id.value }}'>
                                            <option class="optionValue" value="{{ form.room_number.value }}">{{ form.id.value }}</option>
                                        </select>
                                        <div id ='error_room_number' class="error-field"></div>
                                    </div>
                                    <div id='bed_edit' class="form-group">
                                        <label>Койко-место</label>
                                        <select  name="bed" id="id_bed-{{ form.id.value }}">
                                        </select>
                                        <div id ='error_bed' class="error-field"></div>
                                    </div>
                                    <div class="form-group">
                                        <label>Комментарий</label>
                                        {{ form.comment|attr:"rows='4'" }}
                                        <p id ='error_comment' class="error-field"></p>
                                    </div>
                                    <div class="form-group item-actions flex flex-center last_form_group">
                                        <button name="add_patient"
                                         onclick="validationEditForm('full_name_{{ form.id.value }}',
                                         '{{ form.birthdate.id_for_label }}',
                                          '{{ form.receipt_date.id_for_label }}',
                                           '{{ form.receipt_time.id_for_label }}',
                                            '{{ form.department.id_for_label }}',
                                             '{{ form.type_of_diet.id_for_label }}',
                                              'id-room-number-{{ form.id.value }}',
                                               'id_bed-{{ form.id.value }}',
                                                '{{ form.comment.id_for_label }}',
                                                 '{{ form.id.value }}')">Сохранить</button>
                                        <a class="button white" data-modal-close>Отменить</a>
                                    </div>

                        </div>
                        <div id="patient-archived{{ form.id.value }}" data-modal="patient-archive{{ form.id.value }}" data-modal-width="400">
                            <div class="title align-center">Перенести учётную запись пациента в архив?</div>
                            <div class="confirm-block">
                                <div class="buttons">
                                    <a class="button" onclick="patientArchive('{{ form.id.value }}')">Архивировать</a>
                                    <a id='close{{ form.id.value }}' class="button white" data-modal-close>Отменить</a>
                                </div>
                            </div>
                        </div>
                                        {% endfor %}
                    </div>
                </div>
            </div>


            <div id="right" data-simplebar>
                <div class="patient-card-block">
                    <div class="overlay" data-patient-card-toggle></div>
                    <div class="content">
                        <div class="inner">
                            <div class="toggle" data-patient-card-toggle>
                                <div class="i i-arrow"></div>
                            </div>
                            <div class="block-title">Карточка пациента</div>
                            <div class="tabs">
                                <a class="active" data-tab="profile">Профиль</a>
                                <a data-tab="eat">Выбранные блюда</a>
                            </div>
                            
                            <div class="profile active" data-tab-content="profile">
                                <div id="full_name_field" class="name"></div>
                                <div class="fields">
                                    <div class="field">
                                        <div class="label">Дата рождения</div>
                                        <div id="birthdate_field" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Дата госпитализации</div>
                                        <div id="receipt_datetime_field" class="value"></div>
                                    </div>
                                    <div class="field" style="display: none;">
                                        <div class="label">Дата госпитализации</div>
                                        <div id="receipt_date_field_hidden" class="value"></div>
                                    </div>
                                    <div class="field" style="display: none;">
                                        <div class="label">Время госпитализации</div>
                                        <div id="receipt_time_field_hidden" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Отделение</div>
                                        <div id="department_field" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Диета</div>
                                        <div id="type_of_diet_field" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Номер палаты</div>
                                        <div id="room_number_field" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">Койко-место</div>
                                        <div id="bed_field" class="value"></div>
                                    </div>
                                    <div class="field">
                                        <div id="link_lk_patient" class="label"></div>
                                        <div class="value"></div>
                                    </div>
                                    <div class="field">
                                        <input id="card-user-id" class="hidden-edit" type="text">
                                        <input id="card-floor" class="hidden-edit" type="text">
                                        <input id="card-room" class="hidden-edit" type="text">
                                        <input id="card-bed" class="hidden-edit" type="text">
                                    </div>
                                </div>
                                <div id="comment_field" class="help"></div>
                                <div id="patient-card-button" class="actions">
                                    <a id="modal_field" class="button">Редактировать</a>
                                    <a id="archive_field" class="button white">Архивировать</a>
                                </div>
                            </div>
                            <div class="eat" data-tab-content="eat">
                                <div class="switch">
                                    <a href="#" class="active" data-tab="today">Сегодня</a>
                                    <a href="#" data-tab="tomorrow">Завтра</a>
                                    <a href="#" data-tab="day_after_tomorrow">Послезавтра</a>
                                </div>
                                
                                <div id="today" class="boxes active" data-tab-content="today">
                                    <div class="date">12 июля, вторник</div>
                                </div>
                                <div id="tomorrow" class="boxes" data-tab-content="tomorrow">
                                    <div class="date">12 июля, вторник</div>
                                </div>
                                <div id="day_after_tomorrow" class="boxes" data-tab-content="day_after_tomorrow">
                                    <div class="date">12 июля, вторник</div>
                                </div>                        
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script> -->
<script>
document.getElementById("modal_field").onclick = function() {clickEditForm()};

async function clickEditForm() {
    var userId = document.getElementById("card-user-id").value;
    var userFloor = document.getElementById("card-floor").value;
    var userRoom = document.getElementById("card-room").value;
    var userBed = document.getElementById("card-bed").value;
    var userRoomId = `id-room-number-${userId}`;
    var userNameId = `full_name_${userId}`;
    changeSymbol(userNameId);
    item = document.getElementById(userRoomId);
    while (item.firstChild) {
        item.removeChild(item.firstChild);
    }
    let secondFloor = ['2а-1', '2а-2', '2а-3', '2а-4', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13', '2а-14', '2а-15', '2а-16', '2а-17'];
    let thirdFloor = ['3а-1', '3а-2', '3а-3', '3а-4', '3а-5', '3а-6', '3а-7', '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13', '3а-14', '3а-15', '3а-16', '3а-17'];
    let fourthFloor = ['4а-1', '4а-2', '4а-3', '4а-4', '4а-5', '4а-6', '4а-7', '4а-8', '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14', '4а-15', '4а-16'];
    let divRoomNumber = document.getElementById('room_number_edit');
    let divBed = document.getElementById('bed_edit');

    let res = await getOccupiedRooms('departments');
    var occupiedRooms = JSON.parse(res);
    var occupiedRooms = JSON.parse(occupiedRooms);
    console.log(occupiedRooms)

    let result = '' 
    result += `<option selected value="${userRoom}">${userRoom}</option>`

    if (userFloor == "2") {
        secondFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== userRoom)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit');
    }

    if (userFloor == "3") {
        thirdFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== userRoom)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit');
    }

    if (userFloor == "4") {
        fourthFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== userRoom)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit');
    }

    if (userFloor == "Не выбрано") {
        roomNumberOncology.forEach(function(roomNumber, i, arr) {
            result += `<option value="${roomNumber}">${roomNumber}</option>`;
        });
        divRoomNumber.classList.add('hidden-edit');
    }
    item.insertAdjacentHTML("beforeend", result);



    var userBedId = `id_bed-${userId}`
    item = document.getElementById(userBedId);
    console.log(userBedId)
    let singleRooms = ['2а-1', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13',
                       '2а-14', '2а-15', '3а-1', '3а-5', '3а-6', '3а-7',
                       '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13',
                       '3а-14', '3а-15','4а-1', '4а-6', '4а-7', '4а-8',
                       '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14'];
    let doubleRooms = ['2а-2', '2а-3', '2а-4', '2а-16', '2а-17', '3а-2',
                        '3а-3', '3а-4', '3а-16', '3а-17', '4а-2', '4а-3',
                        '4а-4', '4а-5', '4а-15', '4а-16'];
    divRoomNumber = document.getElementById('bed_edit');


    while (item.firstChild) {
        item.removeChild(item.firstChild);
    }
    result = '';

    res = await getOccupiedRooms('rooms');
    occupiedRooms1 = JSON.parse(res);
    occupiedRooms1 = JSON.parse(occupiedRooms1);
    console.log(occupiedRooms1)

    if (singleRooms.includes(userRoom)) {
        item.setAttribute("disabled", "disabled");
        result += `<option value="K1">K1</option>`;
        document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
        item.insertAdjacentHTML("beforeend", result);
    }

    if (doubleRooms.includes(userRoom)) {
        if (occupiedRooms.includes(userRoom)) {
            item.setAttribute("disabled", "disabled");
            result += `<option value="${userBed}">${userBed}</option>`;
            document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
            item.insertAdjacentHTML("beforeend", result);
        } else {
            item.removeAttribute("disabled");
            result += `<option selected value="${userBed}">${userBed}</option>`;
            if (userBed === 'K1') {
                result += `<option value="K2">K2</option>`;
            } else {
                result += `<option value="K1">K1</option>`;
            }
            item.insertAdjacentHTML("beforeend", result);
        }
    }
}

var depList = document.querySelectorAll('.floor-list');
var roomList = document.querySelectorAll('.room-list');
var idList = document.querySelectorAll('.id-list');

for (var ii = 0; ii < depList.length; ii++) {
    let selectDepartmentId = `#id-floor-${idList[ii].value} .optionValue`
    var optionDepartment = document.querySelectorAll(selectDepartmentId);
    let selectRoomId = `#id-room-number-${idList[ii].value} .optionValue`
    var optionRoom = document.querySelectorAll(selectRoomId);
    for (var i = 0; i < optionDepartment.length; i++) {
         console.log(optionDepartment[i].value)
        if (optionDepartment[i].value == depList[ii].value) {
            console.log("Yes");
            optionDepartment[i].selected = true
    }
}
}

const getOccupiedRooms = async function(userScript) {
    let url = 'api/v1/get/occupiedrooms'
    let body = {'user_script': userScript};

    let response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json;',
        },
        body: JSON.stringify(body)
    });
    let result = await response.text();
    return result;
}


async function addRoomNumber(value, idRoomNumber) {
    selectRoomNumber = document.getElementById(idRoomNumber);
    let secondFloor = ['2а-1',  '2а-2', '2а-3', '2а-4', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13', '2а-14', '2а-15', '2а-16', '2а-17'];
    let thirdFloor = ['3а-1', '3а-2', '3а-3', '3а-4', '3а-5', '3а-6', '3а-7', '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13', '3а-14', '3а-15', '3а-16', '3а-17'];
    let fourthFloor = ['4а-1', '4а-2', '4а-3', '4а-4', '4а-5', '4а-6', '4а-7', '4а-8', '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14', '4а-15', '4а-16'];

    let divRoomNumber = document.getElementById('room_number_add');
    let divBed = document.getElementById('bed_add');
    let res = await getOccupiedRooms('departments');
    var occupiedRooms = JSON.parse(res);
    var occupiedRooms = JSON.parse(occupiedRooms);
    console.log(occupiedRooms)

    let result = ''
    result += `<option value="Не выбрано">Не выбрано</option>`;
// удаляем все варианты select
    while (selectRoomNumber.firstChild) {
        selectRoomNumber.removeChild(selectRoomNumber.firstChild);
    }

    if (value == "2") {
        secondFloor.forEach(function(roomNumber, i, arr) {
            if (!occupiedRooms.includes(roomNumber)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "3") {
        thirdFloor.forEach(function(roomNumber, i, arr) {
            if (!occupiedRooms.includes(roomNumber)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "4") {
        fourthFloor.forEach(function(roomNumber, i, arr) {
            if (!occupiedRooms.includes(roomNumber)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "Не выбрано") {
        roomNumberOncology.forEach(function(roomNumber, i, arr) {
            result += `<option value="${roomNumber}">${roomNumber}</option>`;
        });
        divRoomNumber.classList.add('hidden-edit')
        divBed.classList.add('hidden-edit')
    }
    selectRoomNumber.insertAdjacentHTML("beforeend", result);
}

async function addRoomNumberEditForm(value, idRoomNumber, floor, room, bed) {
    selectRoomNumber = document.getElementById(idRoomNumber);
    document.getElementById('bed_edit').classList.add('hidden-edit');
    let secondFloor = ['2а-1', '2а-2', '2а-3', '2а-4', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13', '2а-14', '2а-15', '2а-16', '2а-17'];
    let thirdFloor = ['3а-1', '3а-2', '3а-3', '3а-4', '3а-5', '3а-6', '3а-7', '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13', '3а-14', '3а-15', '3а-16', '3а-17'];
    let fourthFloor = ['4а-1', '4а-2', '4а-3', '4а-4', '4а-5', '4а-6', '4а-7', '4а-8', '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14', '4а-15', '4а-16'];

    let divRoomNumber = document.getElementById('room_number_edit');
    let divBed = document.getElementById('bed_edit');
    let res = await getOccupiedRooms('departments');
    var occupiedRooms = JSON.parse(res);
    var occupiedRooms = JSON.parse(occupiedRooms);
    console.log(occupiedRooms)

    let result = ''
    result += `<option selected value="Не выбрано">Не выбрано</option>`;
// удаляем все варианты select
    while (selectRoomNumber.firstChild) {
        selectRoomNumber.removeChild(selectRoomNumber.firstChild);
    }

    if (value == floor) {
        result += `<option value="${room}">${room}</option>`;
    }

    if (value == "2") {
        secondFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== room)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "3") {
        thirdFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== room)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "4") {
        fourthFloor.forEach(function(roomNumber, i, arr) {
            if ((!occupiedRooms.includes(roomNumber)) && (roomNumber !== room)) {
                result += `<option value="${roomNumber}">${roomNumber}</option>`;
            };
        });
        divRoomNumber.classList.remove('hidden-edit')
        divBed.classList.add('hidden-edit')
    }

    if (value == "Не выбрано") {
        divRoomNumber.classList.add('hidden-edit')
        divBed.classList.add('hidden-edit')
    }
    selectRoomNumber.insertAdjacentHTML("beforeend", result);
}


async function addBed(value) {
    selectBed = document.getElementById('id_bed');
    let singleRooms = ['2а-1', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13',
                       '2а-14', '2а-15', '3а-1', '3а-5', '3а-6', '3а-7',
                       '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13',
                       '3а-14', '3а-15','4а-1', '4а-6', '4а-7', '4а-8',
                       '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14'];
    let doubleRooms = ['2а-2', '2а-3', '2а-4', '2а-16', '2а-17', '3а-2',
                        '3а-3', '3а-4', '3а-16', '3а-17', '4а-2', '4а-3',
                        '4а-4', '4а-5', '4а-15', '4а-16'];
    let divRoomNumber = document.getElementById('bed_add');


    while (selectBed.firstChild) {
        selectBed.removeChild(selectBed.firstChild);
    }
    let result = '';
// получаем список двухместных номеров с одной свободной койкой (номер номера: свободная койка)
    let res = await getOccupiedRooms('rooms');
    var occupiedRooms = JSON.parse(res);
    var occupiedRooms = JSON.parse(occupiedRooms);

    if (singleRooms.includes(value)) {
        selectBed.setAttribute("disabled", "disabled");
        result += `<option value="K1">K1</option>`;
        divRoomNumber.classList.remove('hidden-edit')
        document.querySelector('#bed_add .selection .select2-selection__arrow').classList.add('hidden-edit')
        selectBed.insertAdjacentHTML("beforeend", result);
    }

    if (doubleRooms.includes(value)) {
        if (typeof occupiedRooms[value] !== "undefined") {
            selectBed.setAttribute("disabled", "disabled");
            if (occupiedRooms[value] === 'К1') {
                result += `<option value="K1">K1</option>`;
            } else {
                result += `<option value="K2">K2</option>`;
            }
            divRoomNumber.classList.remove('hidden-edit')
            document.querySelector('#bed_add .selection .select2-selection__arrow').classList.add('hidden-edit')
            selectBed.insertAdjacentHTML("beforeend", result);
        } else {
            selectBed.removeAttribute("disabled");
            result += `<option value="Не выбрано">Не выбрано</option>`;
            result += `<option value="K1">K1</option>`;
            result += `<option value="K2">K2</option>`;
            divRoomNumber.classList.remove('hidden-edit')
            document.querySelector('#bed_add .selection .select2-selection__arrow').classList.remove('hidden-edit')
            selectBed.insertAdjacentHTML("beforeend", result);
        }
    }
    if (value == "Не выбрано") {
        divRoomNumber.classList.add('hidden-edit');
    }
}

async function addBedEditForm(value, idBed, userRoom, userBed) {
    selectBed = document.getElementById(idBed);
    let singleRooms = ['2а-1', '2а-5', '2а-6', '2а-7', '2а-12', '2а-13',
                       '2а-14', '2а-15', '3а-1', '3а-5', '3а-6', '3а-7',
                       '3а-8', '3а-9', '3а-10', '3а-11', '3а-12', '3а-13',
                       '3а-14', '3а-15','4а-1', '4а-6', '4а-7', '4а-8',
                       '4а-9', '4а-10', '4а-11', '4а-12', '4а-13', '4а-14'];
    let doubleRooms = ['2а-2', '2а-3', '2а-4', '2а-16', '2а-17', '3а-2',
                        '3а-3', '3а-4', '3а-16', '3а-17', '4а-2', '4а-3',
                        '4а-4', '4а-5', '4а-15', '4а-16'];
    let divRoomNumber = document.getElementById('bed_edit');


    while (selectBed.firstChild) {
        selectBed.removeChild(selectBed.firstChild);
    }
    let result = '';
// получаем список двухместных номеров с одной свободной койкой (номер номера: свободная койка)
    let res = await getOccupiedRooms('departments');
    var occupiedRooms = JSON.parse(res);
    var occupiedRooms = JSON.parse(occupiedRooms);
    console.log(occupiedRooms)


    res = await getOccupiedRooms('rooms');
    occupiedRooms1 = JSON.parse(res);
    occupiedRooms1 = JSON.parse(occupiedRooms1);

    if (value === userRoom) {
        if (singleRooms.includes(userRoom)) {
            selectBed.setAttribute("disabled", "disabled");
            result += `<option value="K1">K1</option>`;
            document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
            selectBed.insertAdjacentHTML("beforeend", result);
        }

        if (doubleRooms.includes(userRoom)) {
            if (occupiedRooms.includes(userRoom)) {
                selectBed.setAttribute("disabled", "disabled");
                result += `<option value="${userBed}">${userBed}</option>`;
                document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
                selectBed.insertAdjacentHTML("beforeend", result);
            } else {
                selectBed.removeAttribute("disabled");
                result += `<option selected value="${userBed}">${userBed}</option>`;
                if (userBed === 'K1') {
                    result += `<option value="K2">K2</option>`;
                } else {
                    result += `<option value="K1">K1</option>`;
                }
                // document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.remove('hidden-edit')
                selectBed.insertAdjacentHTML("beforeend", result);
            }
        }
    } else {
        if (singleRooms.includes(value)) {
            selectBed.setAttribute("disabled", "disabled");
            result += `<option value="K1">K1</option>`;
            divRoomNumber.classList.remove('hidden-edit')
            document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
            selectBed.insertAdjacentHTML("beforeend", result);
        }

        if (doubleRooms.includes(value)) {
            if (typeof occupiedRooms[value] !== "undefined") {
                selectBed.setAttribute("disabled", "disabled");
                if (occupiedRooms[value] === 'К1') {
                    result += `<option value="K1">K1</option>`;
                } else {
                    result += `<option value="K2">K2</option>`;
                }
                divRoomNumber.classList.remove('hidden-edit')
                document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.add('hidden-edit')
                selectBed.insertAdjacentHTML("beforeend", result);
            } else {
                selectBed.removeAttribute("disabled");
                result += `<option value="Не выбрано">Не выбрано</option>`;
                result += `<option value="K1">K1</option>`;
                result += `<option value="K2">K2</option>`;
                divRoomNumber.classList.remove('hidden-edit')
                document.querySelector('#bed_edit .selection .select2-selection__arrow').classList.remove('hidden-edit')
                selectBed.insertAdjacentHTML("beforeend", result);
            }
        }
        if (value == "Не выбрано") {
            divRoomNumber.classList.add('hidden-edit');
        }
        }
    divRoomNumber.classList.remove('hidden-edit')
}


let not_active_users_set = '{{not_active_users_set}}'.split(",");
if (not_active_users_set[0] != 'none') {
    for (var index in not_active_users_set ) {
        document.getElementById(not_active_users_set[index]).classList.add('not-active')
        }
}
filtration()


async function displayInfoPatient(full_name, birthdate, receipt_date, receipt_time, department, type_of_diet, room_number, bed, comment, id, floor) {
    document.getElementById("full_name_field").innerHTML = full_name;
    document.getElementById("birthdate_field").innerHTML = birthdate;
    document.getElementById("receipt_datetime_field").innerHTML = receipt_date + ', ' + receipt_time;
    document.getElementById("department_field").innerHTML = department;
    document.getElementById("card-floor").value = floor;
    document.getElementById("type_of_diet_field").innerHTML = type_of_diet;
    document.getElementById("room_number_field").innerHTML = room_number;
    document.getElementById("card-room").value = room_number;
    document.getElementById("card-bed").value = bed;
    document.getElementById("bed_field").innerHTML = bed;
    document.getElementById("comment_field").innerHTML = comment;
    document.getElementById("card-user-id").value = id;
    if (comment.length == 0) {
        document.getElementById("link_lk_patient").innerHTML = '<a href="https://sk.petrushkagroup.com/patient/' + id + '">ЛК пациента</a>';
    } else {
        document.getElementById("link_lk_patient").innerHTML = ''
    }
    // var d = document.getElementById("patient-card-button");
    // var d_nested = document.getElementById("modal_field");
    // var throwawayNode = d.removeChild(d_nested);
    // document.getElementById("patient-card-button").insertAdjacentHTML("afterbegin", `<a id="modal_field"  class="button">Редактировать</a>`);

    document.getElementById("modal_field").setAttribute('data-modal-link', 'modal-start'+id);
    // document.getElementById("modal_field").classList.add("modal-link-processed");
    document.getElementById("archive_field").setAttribute('data-modal-link', 'patient-archive'+id); 
    document.getElementById("receipt_date_field_hidden").innerHTML = receipt_date;
    document.getElementById("receipt_time_field_hidden").innerHTML = receipt_time;

    let receiptDate = receipt_date
    let res = await getMenuForPatient(id)
    var obj = JSON.parse(res);
    var obj = JSON.parse(obj);
    console.log(receipt_date)
    let days = {
        today: {"name": "today", "date": ""},
        tomorrow: {"name": "tomorrow", "date": ""},
        day_after_tomorrow: {"name": "day_after_tomorrow", "date": ""}
    }
    let meals = {
        breakfast: "Завтрак", 
        lunch: "Обед", 
        afternoon: "Полдник", 
        dinner: "Ужин"
    }
    let item, result, product
    for (day in days) {
        addHtml(day, obj, meals, item, result, product, receiptDate);
    }
}


function addHtml(day, obj, meals, item, result, product, receiptDate) {
    // Добавляет меню на один день в выборе пациента
    item = document.getElementById(day)

    while (item.firstChild) {
        item.removeChild(item.firstChild);
    }
    result = '';
    result += '<div class="date">' + obj[day].date_human_style + '</div>'
    console.log(obj)
    console.log('receipt_date-', Date.parse(receiptDate))
// проверяем, если дата раньше даты госпитализации, выводим сообщение
    receiptDate = receiptDate.split(".");
    receiptDate = new Date(receiptDate[2], receiptDate[1] - 1, receiptDate[0]);

    let menuDate = obj[day].date
    menuDate = menuDate.split("-");
    menuDate = new Date(menuDate[0], menuDate[1] - 1, menuDate[2]);


    if (moment(receiptDate).isBefore(menuDate, 'days') || moment(receiptDate).isSame(menuDate, 'days')) {
        for (var meal in meals ) {
            result += `<div class="box"><div id="test" class="title">${meals[meal]}</div><div id="products-list" class="products-list">`
            for (var key in obj[day][meal]) {
                if (obj[day][meal][key] != null) {
                    product = obj[day][meal][key]
                    isNotProducts = false
                    result += '<div class="item">'
                    if (product.image == null) {
                        result += '<div class="img">'
                        if (key == 'main') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/main-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/main-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'salad') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/salad-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/salad-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'soup') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/soup-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/soup-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'dessert') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/dessert-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/dessert-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'porridge') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/porridge-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/porridge-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'fruit') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/fruit-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/fruit-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'drink') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/drink-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/drink-doctor.png" %}" alt=""></div>'
                        }
                        if (key == 'garnish') {
                            result +='<img width="96" height="96" src="{% static "doctor/css/img/garnish-doctor.png" %}" alt="">'
                            result +='</div>'
                            result +='<div class="info"><div class="img"><img width="96" height="96" src="{% static "doctor/css/img/garnish-doctor.png" %}" alt=""></div>'
                        }
                    } else {
                        result += '<div class="img"><img width="96" height="96" src="https://hadassah.petrushkagroup.com/imagecache/product/'+ product.image +'" alt=""></div>'
                        result += '<div class="info"><div class="img"><img width="96" height="96" src="https://hadassah.petrushkagroup.com/imagecache/product/'+ product.image +'" alt=""></div>'
                    }
                    result += '<div id="name_today" class="name">' + product.name + '</div>'
                    result += '<div class="value">' + 'Б - '+ formattingFFC(product.fiber) +  ', Ж -  '+ formattingFFC(product.fat) +  ', У -  '+ formattingFFC(product.carbohydrate) + ', Ккал - ' + formattingFFC(product.energy) +  '</div>'
                    result += '<div class="text">' + product.description + '</div>' 
                    result += '</div></div>'
                }
            }
            result += '</div></div>'
        }
    } else {
        result += 'Выбранная дата раньше даты госпитализации, данные недоступны'
    }
    item.insertAdjacentHTML("beforeend", result);
}

function formattingFFC(value) {
    if (value == null) {
        return '0'
    }
    else {
        return value
    }
}


const getMenuForPatient = async function(userId) {
    let url = '/doctor/api/v1/patient/menu'
    let body = {
        "id_user": userId
    };

    let response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json;',
      },
      body: JSON.stringify(body)
    });
    let result = await response.text();

    return result;
}



const list = document.querySelectorAll('.product')
    list.forEach(item =>{
        item.addEventListener('click', (e) =>{
        list.forEach(el=>{ el.classList.remove('active'); });
        item.classList.add('active')
    })
})


const list1 = document.querySelectorAll('.tag')
 list1.forEach(item1 =>{
        if (item1.innerHTML == 'ОВД') {
            item1.classList.add('green')
        }
        if (item1.innerHTML == 'ОВД б/с') {
            item1.classList.add('mint')
        }
        if (item1.innerHTML == 'ОВД без сахара') {
            item1.innerHTML = 'ОВД б/с'
            item1.classList.add('mint')
        }
        if (item1.innerHTML == 'ЩД') {
            item1.classList.add('yellow')
        }
        if (item1.innerHTML == 'БД') {
            item1.classList.add('pink')
        }
        if (item1.innerHTML == 'БД день 1') {
            item1.classList.add('pink')
        }
        if (item1.innerHTML == 'БД день 2') {
            item1.classList.add('pink')
        }
        if (item1.innerHTML == 'ВБД') {
            item1.classList.add('orange')
        }
        if (item1.innerHTML == 'НБД') {
            item1.classList.add('red')
        }
        if (item1.innerHTML == 'НКД') {
            item1.classList.add('blue')
        }
        if (item1.innerHTML == 'ВКД') {
            item1.classList.add('purple')
        }
})


// фильтрация/сортировка страницы
function check_function(value) {
    
    var form = document.getElementById('main-form');
    let filterBy = document.getElementById('filter_by').innerHTML

    if (document.getElementById(value).checked) {
        document.getElementById('is_pressing_again').value = 'True'
    } else {

        document.getElementById('is_pressing_again').value = 'False'
    }
    document.getElementById(value).setAttribute('checked', 'true');
    document.getElementById('filter_by_flag').setAttribute('checked', 'true');
    if ((document.getElementById(filterBy).classList.contains('desc'))) {
        document.getElementById('sorting_value').value = 'down'
    } else {
        document.getElementById('sorting_value').value = 'top'
    }
    form.submit();
}


function filtration() {
    let sorting = document.getElementById('sorting').innerHTML
    let filterBy = document.getElementById('filter_by').innerHTML
    document.getElementById(filterBy).classList.add('active');
    document.getElementById('input_' + filterBy).setAttribute('checked', 'true');
    if (sorting == 'down') {
        document.getElementById(filterBy).classList.add('desc');
    }
}


function validationForm() {
    var form = document.getElementById('main-form');
    var fields = form.querySelectorAll('.field');
    var full_name = document.getElementById('id_full_name');
    var floor = document.getElementById('id_floor');
    var birthdate = document.getElementById('id_birthdate');
    var receipt_date = document.getElementById('id_receipt_date');
    var receipt_time = document.getElementById('id_receipt_time');
    var department = document.getElementById('id_department');
    var type_of_diet = document.getElementById('id_type_of_diet');
    var floor = document.getElementById('id_floor');
    var room_number = document.getElementById('id_room_number');
    var bed = document.getElementById('id_bed');
    var comment = document.getElementById('id_comment');
    var errors = document.querySelectorAll('.error-field');
    var formGroup = document.querySelectorAll('.form-group');
    for (var i = 0; i < errors.length; i++) {
        errors[i].innerHTML = '';
        errors[i].classList.remove('error');
        formGroup[i].classList.remove('error');
    }
    var error = 0
    var st = new RegExp("[^а-яА-Яa-zA-Z0-9ёЁ+/)/(/-/'/ /./,-]+");
    if (!full_name.value) {
        document.getElementById('error_full_name').innerHTML = 'Обязательное поле';
        document.getElementById('error_full_name').classList.add('error');
        document.getElementById('full_name_add').classList.add('error');
        error = error + 1;
    }
    if (st.test(full_name.value)) {
        document.getElementById('error_full_name').innerHTML = "Поле может содержать только буквы и символы ()-,'.";
        document.getElementById('error_full_name').classList.add('error');
        document.getElementById('full_name_add').classList.add('error');
        error = error + 1
    }
    if (!birthdate.value) {
        document.getElementById('error_birthdate').innerHTML = 'Обязательное поле';
        document.getElementById('error_birthdate').classList.add('error');
        document.getElementById('birthdate_add').classList.add('error');
        error = error + 1
    }
    if (!receipt_date.value) {
        document.getElementById('error_receipt_date').innerHTML = 'Обязательное поле';
        document.getElementById('error_receipt_date').classList.add('error');
        document.getElementById('receipt_date_add').classList.add('error');
        error = error + 1
    }

    let nowDate = new Date();
    let todayDate = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate(), nowDate.getHours(), nowDate.getMinutes());
    let receiptDateListNew = (receipt_date.value).split(".");
    let receiptTimeListNew = (receipt_time.value).split(":");
    receiptDateNew = new Date(receiptDateListNew[2], receiptDateListNew[1] - 1, receiptDateListNew[0], receiptTimeListNew[0], receiptTimeListNew[1])

    if (moment(receiptDateNew).isBefore(todayDate, 'day')) {
            document.getElementById('error_receipt_date').innerHTML = 'Дата госпитализации не может быть раньше текущей даты';
            document.getElementById('error_receipt_date').classList.add('error');
            document.getElementById('receipt_date_add').classList.add('error');
            error = error + 1
        }
    if (moment(receiptDateNew).isSame(todayDate, 'day')) {
        if (moment(receiptDateNew).isBefore(todayDate, 'minute')) {
            document.getElementById('error_receipt_time').innerHTML = 'Время госпитализации не может быть раньше текущего времени';
            document.getElementById('error_receipt_time').classList.add('error')
            document.getElementById('receipt_time_add').classList.add('error');
            error = error + 1
            
        }
    }


    if (!receipt_time.value) {
        document.getElementById('error_receipt_time').innerHTML = 'Обязательное поле'
        document.getElementById('error_receipt_time').classList.add('error')
        document.getElementById('receipt_time_add').classList.add('error')
        error = error + 1
    }

    if (floor.value == 'Не выбрано') {
        document.getElementById('error_floor').innerHTML = 'Обязательное поле'
        document.getElementById('error_floor').classList.add('error')
        document.getElementById('floor_add').classList.add('error')
        error = error + 1
    }

    if (department.value == 'Не выбрано') {
        document.getElementById('error_department').innerHTML = 'Обязательное поле'
        document.getElementById('error_department').classList.add('error')
        document.getElementById('department_add').classList.add('error')
        error = error + 1
    }

    if (type_of_diet.value == 'Не выбрано') {
        document.getElementById('error_type_of_diet').innerHTML = 'Обязательное поле'
        document.getElementById('error_type_of_diet').classList.add('error')
        document.getElementById('type_of_diet_add').classList.add('error')
        error = error + 1
    }

    if (floor.value == 'Не выбрано') {
        document.getElementById('error_floor').innerHTML = 'Обязательное поле'
        document.getElementById('error_floor').classList.add('error')
        document.getElementById('floor_add').classList.add('error')
        error = error + 1
    }

    if (room_number.value == 'Не выбрано') {
        document.getElementById('error_room_number').innerHTML = 'Обязательное поле'
        document.getElementById('error_room_number').classList.add('error')
        document.getElementById('room_number_add').classList.add('error')
        error = error + 1
    }

    if (bed.value == 'Не выбрано') {
        document.getElementById('error_bed').innerHTML = 'Обязательное поле'
        document.getElementById('error_bed').classList.add('error')
        document.getElementById('bed_add').classList.add('error')
        error = error + 1
    }

    if (error == 0) {
        document.getElementById('add_patient_flag').setAttribute('checked', 'true');
        document.getElementById('test_full_name').value = full_name.value
        document.getElementById('test_birthdate').value = birthdate.value
        document.getElementById('test_floor').value = floor.value
        document.getElementById('test_receipt_date').value = receipt_date.value
        document.getElementById('test_receipt_time').value = receipt_time.value
        document.getElementById('test_department').value = department.value
        document.getElementById('test_type_of_diet').value = type_of_diet.value
        document.getElementById('test_room_number').value = room_number.value
        document.getElementById('test_bed').value = bed.value
        document.getElementById('test_comment').value = id_comment.value
        form.submit();
    }
}


function validationEditForm(id_full_name, id_birthdate, id_receipt_date, id_receipt_time, id_department, id_type_of_diet, id_room_number, id_bed, id_comment, id) {
    var form = document.getElementById('main-form');
    var full_name = document.getElementById(id_full_name)
    var birthdate = document.getElementById(id_birthdate)
    var receipt_date = document.getElementById(id_receipt_date)
    var receipt_time = document.getElementById(id_receipt_time)
    var department = document.getElementById(id_department)
    var type_of_diet = document.getElementById(id_type_of_diet)
    var room_number = document.getElementById(id_room_number)
    var bed = document.getElementById(id_bed)
    var comment = document.getElementById(id_comment)

    var errors = document.querySelectorAll('.error-field')
    var formGroup = document.querySelectorAll('.form-group')
    for (var i = 0; i < errors.length; i++) {
        errors[i].innerHTML = '';
        errors[i].classList.remove('error');
        formGroup[i].classList.remove('error');
    }
    var error = 0
    var st = new RegExp("[^а-яА-Яa-zA-Z0-9ёЁ+/)/(/-/'/ /./,-]+");
    if (!full_name.value) {
        document.getElementById('error_full_name').innerHTML = 'Обязательное поле'
        document.getElementById('error_full_name').classList.add('error')
        document.getElementById('full_name_edit').classList.add('error')
        error = error + 1
    }

    if (!birthdate.value) {
        document.getElementById('error_birthdate').innerHTML = 'Обязательное поле';
        document.getElementById('error_birthdate').classList.add('error');
        document.getElementById('birthdate_edit').classList.add('error');
        error = error + 1
    }

    if (st.test(full_name.value)) {
        document.getElementById('error_full_name').innerHTML = "Поле может содержать только буквы и символы ()-,'."
        document.getElementById('error_full_name').classList.add('error')
        document.getElementById('full_name_edit').classList.add('error')
        error = error + 1
    }
    if (!receipt_date.value) {
        document.getElementById('error_receipt_date').innerHTML = 'Обязательное поле'
        document.getElementById('error_receipt_date').classList.add('error')
        document.getElementById('receipt_date_edit').classList.add('error')

        error = error + 1
    }

    let nowDate = new Date();
    let todayDate = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate(), nowDate.getHours(), nowDate.getMinutes());
    let receiptDateListNew = (receipt_date.value).split(".");
    let receiptTimeListNew = (receipt_time.value).split(":");
    receiptDateNew = new Date(receiptDateListNew[2], receiptDateListNew[1] - 1, receiptDateListNew[0], receiptTimeListNew[0], receiptTimeListNew[1])

    let receiptDateOld = document.getElementById("receipt_date_field_hidden").innerHTML
    let receiptTimeOld = document.getElementById("receipt_time_field_hidden").innerHTML
    let receiptDateListOld = (receiptDateOld).split(".");
    let receiptTimeListOld = (receiptTimeOld).split(":");
    receiptDateOld = new Date(receiptDateListOld[2], receiptDateListOld[1] - 1, receiptDateListOld[0], receiptTimeListOld[0], receiptTimeListOld[1])
    receiptTimeNew = new Date(receiptDateListOld[0], receiptDateListOld[1] - 1, receiptDateListOld[2], receiptTimeListNew[0], receiptTimeListNew[1])
    if ((!moment(receiptDateNew).isSame(receiptDateOld, 'minute')) && 
    (!document.getElementById(id).classList.contains('not-active'))) {
        if (!moment(receiptDateNew).isSame(receiptDateOld, 'day')) {
            document.getElementById('error_receipt_date').innerHTML = 'Нельзя менять дату, если пациент уже госпитализирован';
            document.getElementById('error_receipt_date').classList.add('error');
            document.getElementById('receipt_date_edit').classList.add('error');
            error = error + 1;
        }
        if (!moment(receiptTimeNew).isSame(receiptDateOld, 'minute')) {
            document.getElementById('error_receipt_time').innerHTML = 'Нельзя менять время, если пациент уже госпитализирован';
            document.getElementById('error_receipt_time').classList.add('error');
            document.getElementById('receipt_time_edit').classList.add('error');
            error = error + 1;
        }
    }

    // if (!moment(receiptDateNew).isSame(receiptDateOld, 'minute')) {
    //     if ((moment(receiptDateOld).isBefore(todayDatePluseTwoHours, 'minute')) ||
    //        (moment(receiptDateOld).isSame(todayDatePluseTwoHours, 'minute'))) {
    //         document.getElementById('error_receipt_date').innerHTML = 'Нельзя менять дату, если пациент уже госпитализирован';
    //         document.getElementById('error_receipt_date').classList.add('error');
    //         document.getElementById('receipt_date_edit').classList.add('error');
    //         document.getElementById('error_receipt_time').innerHTML = 'Нельзя менять дату, если пациент уже госпитализирован';
    //         document.getElementById('error_receipt_time').classList.add('error')
    //         document.getElementById('receipt_time_edit').classList.add('error');
    //         error = error + 1
    //     }
    // }

    // if (!moment(receiptDateNew).isSame(receiptDateOld, 'minute')) {
    //         if (moment(receiptDateNew).isBefore(todayDate, 'minute')) {
    //         document.getElementById('error_receipt_date').innerHTML = 'Дата и время госпитализации не может быть раньше текущей';
    //         document.getElementById('error_receipt_date').classList.add('error');
    //         document.getElementById('receipt_date_edit').classList.add('error');
    //         document.getElementById('error_receipt_time').innerHTML = 'Дата и время госпитализации не может быть раньше текущей';
    //         document.getElementById('error_receipt_time').classList.add('error')
    //         document.getElementById('receipt_time_edit').classList.add('error');
    //         error = error + 1
    //     }
    // }


    if (!receipt_time.value) {
        document.getElementById('error_receipt_time').innerHTML = 'Обязательное поле'
        document.getElementById('error_receipt_time').classList.add('error')
        document.getElementById('receipt_time_edit').classList.add('error')
        error = error + 1
    }
    if (department.value == 'Не выбрано') {
        document.getElementById('error_department').innerHTML = 'Обязательное поле'
        document.getElementById('error_department').classList.add('error')
        document.getElementById('department_edit').classList.add('error')
        error = error + 1
    }

    if (type_of_diet.value == 'Не выбрано') {
        document.getElementById('error_type_of_diet').innerHTML = 'Обязательное поле'
        document.getElementById('error_type_of_diet').classList.add('error')
        document.getElementById('type_of_diet_edit').classList.add('error')
        error = error + 1
    }
    if (room_number.value == 'Не выбрано') {
        document.getElementById('error_room_number').innerHTML = 'Обязательное поле'
        document.getElementById('error_room_number').classList.add('error')
        document.getElementById('room_number_edit').classList.add('error')
        error = error + 1
    }

    if (error == 0) {
        document.getElementById('edit_patient_flag').setAttribute('checked', 'true');
        document.getElementById('id_edit_user').value = id
        document.getElementById('test1_full_name').value = full_name.value
        document.getElementById('test1_birthdate').value = birthdate.value
        document.getElementById('test1_receipt_date').value = receipt_date.value
        document.getElementById('test1_receipt_time').value = receipt_time.value
        document.getElementById('test1_department').value = department.value
        document.getElementById('test1_type_of_diet').value = type_of_diet.value
        document.getElementById('test1_room_number').value = room_number.value
        document.getElementById('test1_bed').value = bed.value
        document.getElementById('test1_comment').value = comment.value
        document.getElementById('edit_patient_flag').setAttribute('checked', 'true');
        form.submit()

    }
 }

function patientArchive(id) {
    var form = document.getElementById('main-form');
    document.getElementById('id_edit_user').value = id;
    document.getElementById('archive').setAttribute('checked', 'true');
    form.submit()
}

async function validationChangeEmailForm() {
    var form1 = document.getElementById('profile-form-id');
    var email = document.getElementById('change-email')
    var errors = document.getElementById('change-email-error')
    document.getElementById('change-email-form').classList.remove('error')
    errors.innerHTML = ""
    var error = 0
    var st = new RegExp("[^a-zA-Z0-9/-/./@/_-]+");
    if (st.test(email.value)) {
        document.getElementById('change-email-error').innerHTML = "Такой почты не существует"
        document.getElementById('change-email-error').classList.add('error')
        document.getElementById('change-email-form').classList.add('error')
        error = error + 1
    }
    if (!email.value.includes('@') || !email.value.includes('.')) {
        document.getElementById('change-email-error').innerHTML = 'Такой почты не существует'
        document.getElementById('change-email-error').classList.add('error')
        document.getElementById('change-email-form').classList.add('error')
        error = error + 1
    }

    if (error == 0) {
        document.getElementById('change-email_flag').setAttribute('checked', 'true');
        document.getElementById('changed-email').value = email.value
        form1.submit();
    }
}

async function validationChangePasswordForm() {
    var form1 = document.getElementById('profile-form-id');
    var old_password = document.getElementById('old_password');
    var new_password = document.getElementById('new_password');
    document.getElementById('old-password-error').innerHTML = "";
    document.getElementById('new-password-error').innerHTML = "";
    document.getElementById('change-email-form-old-password').classList.remove('error');
    document.getElementById('change-email-form-new-password').classList.remove('error')
 
    var error = 0
    let res = await checkPassword('{{ user.id }}', old_password.value)
    if (!res) {
            document.getElementById('change-email-form-old-password').classList.add('error');
            document.getElementById('old-password-error').classList.add('error');
            document.getElementById('old-password-error').innerHTML = 'Введён неверный пароль';
            error = error + 1;
        }
    if (new_password.value == old_password.value) {
        document.getElementById('change-email-form-new-password').classList.add('error')
        document.getElementById('new-password-error').classList.add('error');
        document.getElementById('new-password-error').innerHTML = 'Пароли совпадают';
        error = error + 1
    }
    if (error == 0) {        
        document.getElementById('change-password_flag').setAttribute('checked', 'true');
        document.getElementById('changed-password').value = new_password.value
        form1.submit();
    }
}

const checkPassword = async function(userId, oldPassword) {
    let url = 'https://www.sk.petrushkagroup.com/doctor/api/v1/password/verify'
    let body = {
        "id_user": userId,
        "row_password": oldPassword
    };

    let response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json;',
      },
      body: JSON.stringify(body)
    });
    let result = await response.text();
    console.log(result, userId, oldPassword)
    console.log(JSON.stringify(body))
    console.log(typeof(result))
    console.log(result == 'Yes')
    console.log(result == "Yes")
    if (result === "\"Yes\"") {
        return true;
    } else {
        return false;
    }
}

const checkPasswordTest = async function(userId, oldPassword) { 
    let promise = new Promise((resolve, reject) => {
        setTimeout(() => resolve("готово!"), 1000)
  });

  let result = await promise;
}

function clickOnElement () {
    if ('{{ id_edited_user }}' == '') {
        const elements = document.querySelectorAll('.product')
        if (elements.length > 0) {
            elements[0].click()
        } 
    } else {
        clickOnEditedElement();
    }    
}


function clickOnEditedElement() {
    document.getElementById('{{ id_edited_user }}').click();
}




clickOnElement();
function changeSymbol(id) {
    let nameInput = document.getElementById(id);
    nameInput.addEventListener("input", function() {
        if (this.value.charCodeAt(this.value.length - 1) == 1105) {
            this.value = this.value.slice(0, -1) + 'е';
        }
        if (this.value.charCodeAt(this.value.length - 1) == 1025) {
            this.value = this.value.slice(0, -1) + 'Е';
        }
})
}





// $('.test').magnificPopup();




</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>



{% endblock %}