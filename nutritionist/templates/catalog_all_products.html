<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Каталог блюд</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
    

    <!-- Add additional CSS in static file -->
    {% load static %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="{% static 'doctor/select/css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'doctor/css/foods.css' %}">
    <script src="{% static 'doctor/select/js/select2.min.js' %}"></script>
    
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script> -->
    

</head>
<body>
{% load static %}

<div class="container-flex">
    <div class="div-order">
        <div class="order">
            <button class="btn btn-info" id="modal-start" type="button" data-bs-toggle="modal" data-bs-target="#modal-delet">
                Выбрать категорию блюд
            </button>
        </div>
    </div>
    <div class="div-order">
        <div class="order">
            <h1>Каталог блюд</h1>
        </div>
    </div>
</div>


<table id='table' width="100%">

</table>

<div id="modal-delet" class="modal">
    <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Выбор категории</h5>
                <button id="close-modal" type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
               <p id="modal-body">
                    <div>
                        <label for="inputType">Выберете тип:</label>
                        <select id="inputType" class="form-control">
                            <option value='all' selected>Не выбрано</option>
                            <option value='lp'>Лечебное питание</option>
                            <option value='cafe'>Блюда раздачи</option>
                        </select>
                    </div>
                
                    <div>
                        <label for="inputCat">Выберете категорию:</label>
                        <select id="inputCat" class="form-control">
                            <option value='all' selected>Не выбрано</option>
                            <option value='salad'>Салаты</option>
                            <option value='soup'>Первые блюда</option>
                            <option value='porridge'>Кашы</option>
                            <option value='main'>Основные блюда</option>
                            <option value='garnish'>Гарниры</option>
                            <option value='dessert'>Десерты</option>
                            <option value='fruit'>Фрукты</option>
                            <option value='drink'>Напитки</option>
                            <option value='products'>Товары</option>
                        </select>
                    </div>
                </p>
            </div>

            <div class="modal-footer">
                <input class="btn btn-info" onclick="changeDishModalforSearch()" type="submit" value="Выбрать">
            </div>

            </div>
        </div>
    </div>
</div>
<button class="hidden" id="modal-start" type="button" data-bs-toggle="modal"data-bs-target="#modal-delet">hidden</button>

<div id="modal-product" class="modal" tabindex="-1">
    <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 id="modal-title-product"></h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Состав: </strong><span id="description"></span></p>
                <hr>
                <p><strong>БЖУ: </strong><span id="PFC"></span></p>
                <hr>
                <p><strong>Способ приготовления: </strong><span id='cooking_method'></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-close btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">
                    Закрыть</button>
            </div>
        </div>
    </div>
</div>
<button class="hidden" id="start-modal-product" type="button" data-bs-toggle="modal" data-bs-target="#modal-product">hidden</button>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
</body>
</html>
<script>

// выбор пациента
$('select').select2();
$(".js-states").select2();
let result;


// ###################
// Запросы по API   ##
// ###################
const updateSearch = async function(type, cat) {
    let url = '/doctor/api/v1/update-search'
    let body = {
        "type": type,
        "cat": cat,
    };

    let response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json;',
      },
      body: JSON.stringify(body)
    });
    let result = await response.text();
    return result;

}

// ###################
// Старт страницы   ##
// ###################
// Показать рацион пациента после открытия страницы
displayDish('lp', 'all')

async function displayDish(type, cat) {

// получаем блюда
    result = await updateSearch(type, cat)
    result = JSON.parse(result);
    addHtmlLeft(result);

// отчистить правую сторону
    // delHtmlRight();
}

function addHtmlLeft(obj) {
    // Добавляет меню на один день в выборе пациента
    tdLeft = document.getElementById('table')
    while (tdLeft.firstChild) {
        tdLeft.removeChild(tdLeft.firstChild);
    }

    let result = "";
    result += '<tr>';
    result += `<td class='meal'>Номер</td>`;
    result += `<td class='meal'>Название</td>`;
    result += `<td class='meal'>Номер ТК</td>`;
    result += '</tr>';

    for (var item in obj) {
            result += `<tr>`;
            result += `<td>${+item + 1}</td>`;
            result += `<td class="pd-top-bot-ziro pd-left-10" >`
            result += `${obj[item]['name']}`
            result += `<img onclick="createModalProduct('${item}')" class="icon" width="17" height="17" title="Информиция о блюде" src="{% static "doctor/css/img/info.svg" %}" alt="Информация о блюде">`
            result += `</td>`;
            result += `<td>${obj[item]['number_tk']}</td>`;
    }

    tdLeft.insertAdjacentHTML("afterbegin", result);
}


function changeDishModalforSearch() {
    let cat = document.getElementById('inputCat').value
    let type = document.getElementById('inputType').value

    document.getElementById('close-modal').click();
    displayDish(type, cat);
}


async function addDishAPI(category, product_id, meal) {
    let res = await addDishForPatient(category, product_id, meal);
    var obj = JSON.parse(res);
    document.getElementById('close-modal').click()
    if (obj['status'] == 'Error') {
        alert('Server error...')
    } else {
        displayInfoPatient()
    }
}

function createModalProduct(item) {
    document.getElementById('modal-title-product').innerHTML = result[item]['name'].replace(/"/g, '&quot;');
    document.getElementById('description').innerHTML = result[item]['description_annotation'].toLowerCase().replace(/"/g, '&quot;').replace('состав: ', '');
    let PFC = `белки - ${result[item]['fiber']} г, жиры - ${result[item]['fat']} г, углеводы - ${result[item]['carbohydrate']} г, ккал - ${result[item]['energy']}.`
    document.getElementById('PFC').innerHTML = PFC;
    document.getElementById('cooking_method').innerHTML = result[item]['cooking_method_annotation'].replace(/"/g, '&quot;').toLowerCase();
    
    document.getElementById('start-modal-product').click();
}

</script>